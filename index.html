<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans" />
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		<script src="WAAclock.js"></script>
	</head>
	<body>
		<h1 style="text-align: center; padding: 50px;">Astound</h1>

		<div style="text-align: center; margin-bottom: 40px;">
			<button id="receivebutton" type="submit">Receive</button>
			<button id="stopbutton" type="submit">Stop Receive!!</button>
			<h5 style="padding:20px;" id="recievetext"> text recieved: </h5>


		</div>
		<div style="margin-left: 43%;padding-bottom: 50px;">
			<input id="in" style="" type="text">
			<button id="button" type="submit">Submit</button>
		</div>


	</body>

	<style>	
		body {
			font-family: "Open Sans";
		}

		.key {

			color:green;
			float:left;
			padding:84px;
			border: 1px solid #ccc;
		}

		.playing {
			color:white;
			background-color: green;
		}

		
	</style>
	<script>

	var pianoNotes = {
			"A": {
				"freq": 440
			},
			"B": {
				"freq": 1000
			},
			"C": {
				"freq": 261.6
			},
			"D": {
				"freq": 293.66
			},
			"E": {
				"freq": 329.63
			},
			"F": {
				"freq": 349.23
			},
			"G": {
				"freq": 392
			}
		}

		
		var pianoSounds = [];
		var pressedTimeout;
		

		// console.log('brianwang');
		// document.getElementById('button').onclick = function() {
  //  			var freq = $("#freq").val();
  //  			console.log(freq); 
  //  			window.audioContext = new (window.AudioContext || window.webkitAudioContext)()
		// 	var oscillator = window.audioContext.createOscillator();
		// 	oscillator.frequency.value = freq;
		//     oscillator.connect(window.audioContext.destination);
		// 	// oscillator.noteOn(window.audioContext.currentTime);
		// 	// oscillator.noteOff(window.audioContext.currentTime + 1.0);
		// 	oscillator.start(0.2);
  //  		}
 		window.audioContext = new (window.AudioContext || window.webkitAudioContext)()

 		function createPiano() {
 			var i = 0;
 			for(keyname in pianoNotes) {
 				var newobj = {};
 				newobj.keyname = keyname;
 				newobj.key = Key(keyname, pianoNotes[keyname].freq);
 				pianoSounds.push(newobj);
 				console.log(newobj);
 				pianoNotes[keyname].freq = i;i++;
 			}
 		}

   		function Key(note, freq) {
   			var newobj = {};
   			var markup = document.createElement("div");
   			markup.className = "key ";
   			markup.setAttribute("id", note);
   			markup.innerHTML = '<span> ' + note + '</span>';
   			document.body.appendChild(markup);
   			newobj.sound = new Sound(freq);
   			return newobj;
   		};

   		function Sound(freq) {
   			this.playing = false;
   			this.freq = freq;
   			//this.oscillator.start(0);
   		}

   		Sound.prototype.play = function() {
   			var oscillator = window.audioContext.createOscillator();
   			oscillator.frequency.value = this.freq;
   			if(!this.playing) {
   				this.playing = true;

   			}
   			oscillator.connect(audioContext.destination);
   			var currentTime = audioContext.currentTime;
   			oscillator.start(currentTime);
   			oscillator.stop(currentTime+0.1);
   			this.playing = false;
   		}

   		Sound.prototype.stop = function(key) {
   			this.playing = false;
   			document.getElementById(key).className = "key";
   		}

   		createPiano();

   		var playKey = function (key) {
   			var index = pianoNotes[key].freq;
   			pianoSounds[index].key.sound.play();
   			var sty = document.getElementById(key);
   			sty.className += " playing";
   			// sty.color = "white";
   			// sty.backgroundColor = "green";
   			//pianoSounds[index].key.sound.stop(key);
                pressedTimeout = window.setTimeout(function() {
                	var temp = $("#"+key);
                    $("#"+key).removeClass('playing');
            	 }, 100);
   		}



   		document.getElementById('button').onclick = function() {
   			var input = $("#in").val();
   			var reg = input.split('').map(Number);
   			console.log(reg);
   			var currentTime = window.audioContext.currentTime;
   			//clock.start();
   			var i =0;
   			recursiveWAA(reg, i);


   			
   			// 	// })
   			// }

   			// var event = clock.setTimeout(function() {
   			// 			playKey(pianoSounds[reg[0]].keyname);
   			// 	}, 1);

   			// var event = clock.setTimeout(function() {
   			// 			playKey(pianoSounds[reg[1]].keyname);
   			// 	}, 2);


   			

   			//playKey("A");
   		}
   		

   		var nextNotetime = 0;

   		function recursiveWAA(arr, i) { 
   				// playKey(pianoSounds[reg[i]].keyname, function() {
   				while(nextNotetime < window.audioContext.currentTime + 0.05) {

   					nextNotetime+=0.1
   					console.log ("i " + i);
   					if(typeof pianoSounds[arr[i]] != 'undefined') {
   						var temp = pianoSounds[arr[i]].keyname;
   						playKey(temp);
   						i++;
   					}
   				}

   				window.setTimeout(function() {
   					recursiveWAA(arr, i);
   				}, 25.0);
   			}


   			var buf = new Float32Array( buflen );
   			var buflen = 1024;
   			var listening = false;

   			//RECEIVE CODE
   			document.getElementById('receivebutton').onclick = function() {
   				listening = true
   				console.log("started listening");
   				$("#in").attr('disabled', true);
   				var analyser = window.audioContext.createAnalyser();
   				analyser.fftSize = 2048;
   				analyser.connect( window.audioContext.destination );

   				var count = 0;
   	 			while(listening) {
	   				analyser.getFloatTimeDomainData( buf );
	   				var ac = autoCorrelate( buf, window.audioContext.sampleRate );
	   				if(ac!=-1) {
	   					var pitch = ac;
		   				var note =  noteFromPitch( pitch );
		   				var realnote = noteStrings[note%12];
		   				console.log(realnote)
	   				} else {
	   					count++;
	   				} 

	   				if(count>5000) {
	   					listening = false;
	   					$("#in").attr('disabled', false);
	   				}
	   			
	   				setTimeout(function() {
	   					//console.log('waiting...');
	   				}, 500);
				 }



   			}

   			var noteStrings = ["C", "C", "D", "D", "E", "F", "F", "G", "G", "A", "A", "B"];

   			function noteFromPitch( frequency ) {
				var noteNum = 12 * (Math.log( frequency / 440 )/Math.log(2) );
				return Math.round( noteNum ) + 69;
			}

			function frequencyFromNoteNumber( note ) {
				return 440 * Math.pow(2,(note-69)/12);
			}

			function centsOffFromPitch( frequency, note ) {
				return Math.floor( 1200 * Math.log( frequency / frequencyFromNoteNumber( note ))/Math.log(2) );
			}


			var MIN_SAMPLES = 0;  // will be initialized when AudioContext is created.
var GOOD_ENOUGH_CORRELATION = 0.9; // this is the "bar" for how close a correlation needs to be

function autoCorrelate( buf, sampleRate ) {
	var SIZE = buf.length;
	var MAX_SAMPLES = Math.floor(SIZE/2);
	var best_offset = -1;
	var best_correlation = 0;
	var rms = 0;
	var foundGoodCorrelation = false;
	var correlations = new Array(MAX_SAMPLES);

	for (var i=0;i<SIZE;i++) {
		var val = buf[i];
		rms += val*val;
	}
	rms = Math.sqrt(rms/SIZE);
	if (rms<0.01) // not enough signal
		return -1;

	var lastCorrelation=1;
	for (var offset = MIN_SAMPLES; offset < MAX_SAMPLES; offset++) {
		var correlation = 0;

		for (var i=0; i<MAX_SAMPLES; i++) {
			correlation += Math.abs((buf[i])-(buf[i+offset]));
		}
		correlation = 1 - (correlation/MAX_SAMPLES);
		correlations[offset] = correlation; // store it, for the tweaking we need to do below.
		if ((correlation>GOOD_ENOUGH_CORRELATION) && (correlation > lastCorrelation)) {
			foundGoodCorrelation = true;
			if (correlation > best_correlation) {
				best_correlation = correlation;
				best_offset = offset;
			}
		} else if (foundGoodCorrelation) {
			// short-circuit - we found a good correlation, then a bad one, so we'd just be seeing copies from here.
			// Now we need to tweak the offset - by interpolating between the values to the left and right of the
			// best offset, and shifting it a bit.  This is complex, and HACKY in this code (happy to take PRs!) -
			// we need to do a curve fit on correlations[] around best_offset in order to better determine precise
			// (anti-aliased) offset.

			// we know best_offset >=1, 
			// since foundGoodCorrelation cannot go to true until the second pass (offset=1), and 
			// we can't drop into this clause until the following pass (else if).
			var shift = (correlations[best_offset+1] - correlations[best_offset-1])/correlations[best_offset];  
			return sampleRate/(best_offset+(8*shift));
		}
		lastCorrelation = correlation;
	}
	if (best_correlation > 0.01) {
		// console.log("f = " + sampleRate/best_offset + "Hz (rms: " + rms + " confidence: " + best_correlation + ")")
		return sampleRate/best_offset;
	}
	return -1;
//	var best_frequency = sampleRate/best_offset;
}

   			

   			document.getElementById('stopbutton').onclick = function() {
   				$("#in").attr('disabled', false);
   				listening = false;
   			}
		      
	</script>
</html>
