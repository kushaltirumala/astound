<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans" />
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		<script src="WAAclock.js"></script>
	</head>
	<body>
		<h1 style="text-align: center; padding: 50px;">Astound</h1>

		<div style="text-align: center; margin-bottom: 40px;">
			<button id="receivebutton" type="submit">Receive</button>
			<button id="stopbutton" type="submit">Stop Receive!!</button>



		</div>
		<div style="margin-left: 43%;padding-bottom: 50px;">
			<input id="in" style="" type="text">
			<button id="button" type="submit">Submit</button>
		</div>


	</body>

	<style>	
		body {
			font-family: "Open Sans";
		}

		.key {

			color:green;
			float:left;
			padding:84px;
			border: 1px solid #ccc;
		}

		.playing {
			color:white;
			background-color: green;
		}

		
	</style>
	<script>

	var pianoNotes = {
			"A": {
				"freq": 440
			},
			"B": {
				"freq": 1000
			},
			"C": {
				"freq": 261.6
			},
			"D": {
				"freq": 293.66
			},
			"E": {
				"freq": 329.63
			},
			"F": {
				"freq": 349.23
			},
			"G": {
				"freq": 392
			}
		}

		
		var pianoSounds = [];
		var pressedTimeout;
		

		// console.log('brianwang');
		// document.getElementById('button').onclick = function() {
  //  			var freq = $("#freq").val();
  //  			console.log(freq); 
  //  			window.audioContext = new (window.AudioContext || window.webkitAudioContext)()
		// 	var oscillator = window.audioContext.createOscillator();
		// 	oscillator.frequency.value = freq;
		//     oscillator.connect(window.audioContext.destination);
		// 	// oscillator.noteOn(window.audioContext.currentTime);
		// 	// oscillator.noteOff(window.audioContext.currentTime + 1.0);
		// 	oscillator.start(0.2);
  //  		}
 		window.audioContext = new (window.AudioContext || window.webkitAudioContext)()

 		function createPiano() {
 			var i = 0;
 			for(keyname in pianoNotes) {
 				var newobj = {};
 				newobj.keyname = keyname;
 				newobj.key = Key(keyname, pianoNotes[keyname].freq);
 				pianoSounds.push(newobj);
 				console.log(newobj);
 				pianoNotes[keyname].freq = i;i++;
 			}
 		}

   		function Key(note, freq) {
   			var newobj = {};
   			var markup = document.createElement("div");
   			markup.className = "key ";
   			markup.setAttribute("id", note);
   			markup.innerHTML = '<span> ' + note + '</span>';
   			document.body.appendChild(markup);
   			newobj.sound = new Sound(freq);
   			return newobj;
   		};

   		function Sound(freq) {
   			this.playing = false;
   			this.freq = freq;
   			//this.oscillator.start(0);
   		}

   		Sound.prototype.play = function() {
   			var oscillator = window.audioContext.createOscillator();
   			oscillator.frequency.value = this.freq;
   			if(!this.playing) {
   				this.playing = true;

   			}
   			oscillator.connect(audioContext.destination);
   			var currentTime = audioContext.currentTime;
   			oscillator.start(currentTime);
   			oscillator.stop(currentTime+0.1);
   			this.playing = false;
   		}

   		Sound.prototype.stop = function(key) {
   			this.playing = false;
   			document.getElementById(key).className = "key";
   		}

   		createPiano();

   		var playKey = function (key) {
   			var index = pianoNotes[key].freq;
   			pianoSounds[index].key.sound.play();
   			var sty = document.getElementById(key);
   			sty.className += " playing";
   			// sty.color = "white";
   			// sty.backgroundColor = "green";
   			//pianoSounds[index].key.sound.stop(key);
                pressedTimeout = window.setTimeout(function() {
                	var temp = $("#"+key);
                    $("#"+key).removeClass('playing');
            	 }, 100);
   		}



   		document.getElementById('button').onclick = function() {
   			var input = $("#in").val();
   			var reg = input.split('').map(Number);
   			console.log(reg);
   			var currentTime = window.audioContext.currentTime;
   			//clock.start();
   			var i =0;
   			recursiveWAA(reg, i);


   			
   			// 	// })
   			// }

   			// var event = clock.setTimeout(function() {
   			// 			playKey(pianoSounds[reg[0]].keyname);
   			// 	}, 1);

   			// var event = clock.setTimeout(function() {
   			// 			playKey(pianoSounds[reg[1]].keyname);
   			// 	}, 2);


   			

   			//playKey("A");
   		}
   		

   		var nextNotetime = 0;

   		function recursiveWAA(arr, i) { 
   				// playKey(pianoSounds[reg[i]].keyname, function() {
   				while(nextNotetime < window.audioContext.currentTime + 0.05) {

   					nextNotetime+=0.1
   					console.log ("i " + i);
   					if(typeof pianoSounds[arr[i]] != 'undefined') {
   						var temp = pianoSounds[arr[i]].keyname;
   						playKey(temp);
   						i++;
   					}
   				}

   				window.setTimeout(function() {
   					recursiveWAA(arr, i);
   				}, 25.0);
   			}

   		

   			//RECEIVE CODE
   			document.getElementById('receivebutton').onclick = function() {
   				console.log("started listening");
   				$("#in").attr('disabled', true);
   			}

   			document.getElementById('stopbutton').onclick = function() {
   				$("#in").attr('disabled', false);
   			}
		      
	</script>
</html>
